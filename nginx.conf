server {
    listen       80;
    server_name  localhost;

    root   /usr/share/nginx/html;
    index  index.html index.htm;

    # 开启gzip压缩
    gzip on;
    gzip_min_length 1k;
    gzip_comp_level 6;
    gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/json;
    gzip_vary on;
    gzip_disable "MSIE [1-6]\.";

    # 处理React路由，刷新不404
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 火山引擎API代理
    location /volc-api/ {
        proxy_pass https://ark.cn-beijing.volces.com/api/v3/;
        proxy_ssl_server_name on;
        proxy_set_header Host ark.cn-beijing.volces.com;
        proxy_set_header Origin https://ark.cn-beijing.volces.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # NewAPI代理
    location /newapi/ {
        proxy_pass https://api.newapi.pro/v1/;
        proxy_ssl_server_name on;
        proxy_set_header Host api.newapi.pro;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # imgbb代理
    location /imgbb-api/ {
        proxy_pass https://api.imgbb.com/1/;
        proxy_ssl_server_name on;
        proxy_set_header Host api.imgbb.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 火山引擎TTS API代理 (V3单向流式)
    # Vite配置: rewrite: (path) => path.replace(/^\/volc-tts/, '/api/v3/tts')
    # Nginx location /volc-tts/ 匹配后，proxy_pass 尾部带 / 会自动去掉匹配部分
    # 但这里目标路径比较特殊 /api/v3/tts，所以我们需要精细控制
    location /volc-tts/ {
        # 注意：这里 proxy_pass 不需要像上面那样自动截断，因为我们需要重写路径
        # Vite rewrite: path.replace(/^\/volc-tts/, '/api/v3/tts')
        # 比如请求 /volc-tts/unidirectional -> /api/v3/tts/unidirectional
        rewrite ^/volc-tts/(.*)$ /api/v3/tts/$1 break;
        proxy_pass https://openspeech.bytedance.com;
        
        proxy_ssl_server_name on;
        proxy_set_header Host openspeech.bytedance.com;
        proxy_set_header Origin https://openspeech.bytedance.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 支持流式响应
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}
